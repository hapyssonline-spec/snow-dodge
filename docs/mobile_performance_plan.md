# План оптимизации mobile-производительности без изменений геймплея и визуала

Цель: снизить нагрев/лаги на телефонах, не меняя игровые механики, баланс, анимационный стиль и внешний вид интерфейса.

## 1) Рендер и кадры (главный приоритет)

1. **Ограничить FPS на мобильных до 45/50 (или адаптивно 30/45/60).**
   - На визуал в большинстве 2D-игр почти не влияет, но сильно снижает нагрузку CPU/GPU и температуру.
   - Реализация: в `requestAnimationFrame` добавить frame-skip по целевому `frameInterval`.

2. **Фиксированный игровой timestep + интерполяция только для отрисовки.**
   - Убирает "спайки" после подвисаний, стабилизирует физику/таймеры.
   - Логика обновляется одинаково, геймплей не меняется.

3. **Dirty rectangles / redraw only when needed для UI-слоёв.**
   - Перерисовывать только изменившиеся участки HUD/оверлеев, а не всё целиком каждый кадр.
   - Особенно полезно для статичных панелей в городе/меню.

4. **Пауза игрового цикла при скрытых оверлеях и `visibilitychange`.**
   - Когда вкладка неактивна или открыт тяжелый overlay, не держать полный loop.
   - Уменьшает фоновый расход батареи и нагрев.

## 2) Canvas и графика

5. **Ограничить `devicePixelRatio` на мобильных (например, до 1.5–2).**
   - На маленьком экране разница минимальна, а число пикселей рендера резко падает.
   - Это часто самый быстрый прирост FPS без изменения арта.

6. **Предрендер статичных слоёв (фон, неизменные декорации) в offscreen-canvas.**
   - Один раз собрать слой и потом копировать его в основной canvas.
   - Снижает количество draw calls и compositing операций.

7. **Sprite atlas для мелких элементов (иконки, части UI-эффектов).**
   - Меньше переключений текстур/источников в `drawImage`.
   - Визуально ничего не меняется.

8. **Явно отключить image smoothing там, где не нужно.**
   - Убирает лишнюю работу ресемплинга для пиксельно-статичных элементов.

## 3) Логика и GC (чтобы убрать фризы)

9. **Убрать аллокации в игровом цикле (object pooling).**
   - Не создавать новые объекты/массивы в каждом кадре/ивенте.
   - Снижает частоту сборки мусора и микрофризы.

10. **Троттлинг/дебаунс частых событий (`resize`, `pointermove`, scroll-like handlers).**
    - На мобильных особенно заметно, когда события приходят чаще чем нужен рендер.

11. **Кешировать вычисления, которые не меняются каждый кадр.**
    - Текстовые метрики, форматирование чисел, lookup-таблицы шансов/редкостей.

12. **Минимизировать чтение layout-свойств в цикле (`offsetWidth`, `getBoundingClientRect`).**
    - Делать batched-measure + batched-mutate, чтобы не вызывать layout thrashing.

## 4) DOM/UI-слой

13. **Свести к минимуму прямые изменения DOM в каждом кадре.**
    - Обновлять текст/классы только при фактическом изменении значений.

14. **`content-visibility: auto` для тяжелых секций, скрытых за вкладками/оверлеями.**
    - Браузер не будет дорого рендерить невидимый контент.

15. **`will-change` использовать точечно и временно.**
    - Держать его только на реально анимируемых элементах; избыток наоборот ухудшает память/GPU.

## 5) Аудио

16. **Снизить частоту одновременных SFX-голосов (voice limit).**
    - Миксинг аудио на слабых устройствах может заметно грузить CPU.

17. **Кешировать/переиспользовать audio nodes, а не создавать часто новые цепочки.**
    - Меньше GC и меньше пиковых нагрузок.

18. **Отключать аудио-обновления, когда игра в фоне/пауза.**
    - Экономит батарею без влияния на игровой опыт.

## 6) Загрузка и память

19. **Отложенная загрузка неиспользуемых экранов/ассетов (lazy init).**
    - Инициализировать тяжелые секции (например, лидерборды/магазины) при первом открытии.

20. **Сжатие изображений до оптимального формата/размера (WebP/AVIF где возможно).**
    - Меньше RAM и быстрее декодирование на старте.

21. **Контроль жизненного цикла крупных изображений.**
    - Освобождать ссылки/кеши при долгом отсутствии необходимости.

## 7) Профилирование и безопасный rollout

22. **Встроить debug-overlay производительности (только dev-режим).**
    - FPS, frame time p95/p99, время update/render, количество активных объектов.

23. **Поставить performance budget.**
    - Цели: `frame <= 16.7ms` (60fps) или `<= 22ms` (45fps), long tasks < 2/мин, без runaway RAM.

24. **Внедрять поэтапно с A/B toggle через локальный флаг.**
    - Каждое изменение включается флажком, проверяется на 2–3 реальных мобильных устройствах.

## Быстрый план внедрения (что даст максимум эффекта сразу)

- **Шаг 1 (1–2 дня):** cap FPS + clamp DPR + пауза при `visibilitychange`.
- **Шаг 2 (1–2 дня):** убрать аллокации из hot-path и троттлинг событий.
- **Шаг 3 (2–3 дня):** предрендер статичных слоёв и оптимизация DOM-обновлений.
- **Шаг 4 (параллельно):** метрики производительности + проверка на реальных устройствах.

Ожидаемый результат: заметное снижение нагрева и более стабильный FPS на мобильных без изменения визуала и геймплея.
